<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ccg_cal_db &mdash; ccglib.python 1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> ccglib.python
            <img src="../_static/NOAA.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../conda.html">conda python â€” Consistent python environment across gml servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../db_utils/index.html">Database routines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filter/index.html">Curve Fitting and Smoothing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tankcals/index.html">Tank Calibrations and History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../insitu/index.html">In-Situ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ccg_date_utils.html">ccg_date_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ccg_dates.html">ccg_dates module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ccg_csv_utils.html">ccg_csv_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ccg_ncdf.html">ccg_ncdf - NetCDF file utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ccg_elevation.html">ccg_elevation module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ccglib.python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>ccg_cal_db</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ccg_cal_db</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># vim: tabstop=4 shiftwidth=4 expandtab</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Class for processing tank calibration results.</span>

<span class="sd">Calibration data is in the &#39;reftank&#39; database.  The table &#39;calibrations&#39;</span>
<span class="sd">has the results, and the table &#39;fill&#39; has filling information.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/ccg/python/ccglib&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">ccg_db_conn</span>
<span class="kn">import</span> <span class="nn">ccg_uncdata_all</span>
<span class="kn">import</span> <span class="nn">ccg_calfit</span>

<span class="n">json</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">FLOAT_REPR</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="nb">format</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;.3f&#39;</span><span class="p">)</span>

<span class="c1"># Update these to specify &#39;official&#39; instrument id&#39;s</span>
<span class="n">INST_CODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;co2&quot;</span><span class="p">:</span> <span class="s2">&quot;U1,U2,U3,U4,U6,S2,S4,S5,L1,L2,L9,PC1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ch4&quot;</span><span class="p">:</span> <span class="s2">&quot;H5,C2,C3,C4,H7,PC1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;co&quot;</span><span class="p">:</span>  <span class="s2">&quot;V1,V2,V3,LGR2,R2,R7&quot;</span><span class="p">,</span>
    <span class="s2">&quot;n2o&quot;</span><span class="p">:</span> <span class="s2">&quot;HP,VC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sf6&quot;</span><span class="p">:</span> <span class="s2">&quot;HP,VC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;h2&quot;</span><span class="p">:</span>  <span class="s2">&quot;R7,P2,H9&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">###########################################################</span>
<div class="viewcode-block" id="get_syslist"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.get_syslist">[docs]</a><span class="k">def</span> <span class="nf">get_syslist</span><span class="p">(</span><span class="n">gas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get list of instrument id&#39;s for &#39;official&#39; instruments &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># combine all analyzer codes and create a unique list of codes</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">INST_CODES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">INST_CODES</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">INST_CODES</span><span class="p">[</span><span class="n">gas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="c1"># add single quotes around each code and create a comma separated string</span>
    <span class="n">tmplist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="n">syslist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmplist</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">syslist</span></div>

<span class="c1">###########################################################</span>
<span class="k">def</span> <span class="nf">_decimalDate</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert a date and time to a fractional year. &quot;&quot;&quot;</span>

    <span class="n">doy</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
    <span class="n">soy</span> <span class="o">=</span> <span class="p">(</span><span class="n">doy</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">86400</span> <span class="o">+</span> <span class="n">hour</span><span class="o">*</span><span class="mi">3600</span> <span class="o">+</span> <span class="n">minute</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="n">second</span>

    <span class="k">if</span> <span class="n">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">soy</span><span class="o">/</span><span class="mf">3.16224e7</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">soy</span><span class="o">/</span><span class="mf">3.1536e7</span>

    <span class="k">return</span> <span class="n">dd</span>


<span class="c1">########################################################################</span>
<span class="k">def</span> <span class="nf">_getTerminalWidth</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns height and width of current terminal. First tries to get</span>
<span class="sd">    size via termios.TIOCGWINSZ, then from environment. Defaults to 25</span>
<span class="sd">    lines x 80 columns if both methods fail.</span>

<span class="sd">    :param fd: file descriptor (default: 1=stdout)</span>

<span class="sd">    from http://blog.taz.net.au/2012/04/09/getting-the-terminal-size-in-python/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">fcntl</span><span class="o">,</span> <span class="nn">termios</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">os</span>
        <span class="n">hw</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;hh&#39;</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="s1">&#39;1234&#39;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LINES&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COLUMNS&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="c1">########################################################################</span>
<div class="viewcode-block" id="Calibrations"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations">[docs]</a><span class="k">class</span> <span class="nc">Calibrations</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        tank : tank serial number</span>
<span class="sd">        gas : gas formula, e.g. &#39;CO2&#39;</span>
<span class="sd">        syslist : comma separated list of instrument id&#39;s to use, e.g. &#39;L8,L10,L4&#39;</span>
<span class="sd">        fillingcode : A fill code letter A-Z. Use calibrations for this filling code only.</span>
<span class="sd">        date : Get calibrations for this date only.  A datetime object.</span>
<span class="sd">        method : Include calibrations for this method too. Method is set in cal raw file, e.g. &#39;NDIR&#39;, &#39;CDRS&#39;, &#39;GC&#39;...</span>
<span class="sd">        official : Use calibrations for &#39;official&#39; calibration systems only.  See INST_CODES dict below.</span>
<span class="sd">        notes : Include data from the &#39;notes&#39; field in output.</span>
<span class="sd">        quiet : If true, suppress warning messages.</span>
<span class="sd">        uncfile : If set, use a calibration uncertainty table different from default</span>
<span class="sd">        database : Specify the database to use.</span>
<span class="sd">        dbconn : Use an already created database connection instead of making a new connection.</span>
<span class="sd">        readonly : Open database in readonly mode by default.  Set to &#39;True&#39; to do updates.</span>

<span class="sd">    Members:</span>

<span class="sd">        * cals : list of dicts containing data about the calibration</span>
<span class="sd">        * flasks : list of dicts with isotope data measured in flasks filled from the tank</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">tank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">gas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">syslist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fillingcode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">official</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">notes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">uncfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">database</span><span class="o">=</span><span class="s1">&#39;reftank&#39;</span><span class="p">,</span>
                 <span class="n">dbconn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">gas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="o">=</span> <span class="n">gas</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tank</span> <span class="o">=</span> <span class="n">tank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fillingcode</span> <span class="o">=</span> <span class="n">fillingcode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span> <span class="o">=</span> <span class="n">notes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">official</span> <span class="o">=</span> <span class="n">official</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;reftank&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span> <span class="c1"># need this for json output</span>

        <span class="k">if</span> <span class="n">syslist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syslist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">syslist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syslist</span> <span class="o">=</span> <span class="n">syslist</span>

        <span class="k">if</span> <span class="n">readonly</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dbconn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">ccg_db_conn</span><span class="o">.</span><span class="n">RO</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">database</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">dbconn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dbconn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">ccg_db_conn</span><span class="o">.</span><span class="n">ProdDB</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">database</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">dbconn</span>

        <span class="c1"># read table with uncertainty values</span>
<span class="c1">#        self.cal_unc = ccg_calunc.CalUnc(uncfile)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cal_unc</span> <span class="o">=</span> <span class="n">ccg_uncdata_all</span><span class="o">.</span><span class="n">dataUnc</span><span class="p">(</span><span class="s1">&#39;cals&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="n">uncfile</span><span class="o">=</span><span class="n">uncfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_tanks</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_fill_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">numcals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="p">)</span>

        <span class="c1"># create a dict of scale names for each gas.  Needed for json output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scales</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_species</span><span class="p">():</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scale</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scales</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>


    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_get_tanks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get serial numbers of all tanks in database &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT DISTINCT serial_number FROM calibrations &quot;</span>

        <span class="n">whereclause</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">:</span> <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;species=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syslist</span><span class="p">:</span> <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;inst in (</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">syslist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">whereclause</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;WHERE &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">whereclause</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;ORDER BY serial_number&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tanks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tanks</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the calibration results from the database. &quot;&quot;&quot;</span>

        <span class="n">whereclause</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">:</span> <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;date=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">:</span> <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;serial_number=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">:</span> <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;species=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syslist</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(inst in (</span><span class="si">%s</span><span class="s2">) OR method=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syslist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;inst in (</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">syslist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">official</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(inst in (</span><span class="si">%s</span><span class="s2">) OR method=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">get_syslist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">whereclause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;inst in (</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">get_syslist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">))</span>


        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM calibrations &quot;</span>
        <span class="k">if</span> <span class="n">whereclause</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;WHERE &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">whereclause</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY date,time&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="c1"># if date is set but tank serial num is not</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_fill_list</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;serial_number&#39;</span><span class="p">])</span>

                <span class="c1"># get fill code for this date</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFillCode</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillingcode</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillingcode</span><span class="p">:</span> <span class="k">continue</span>

                <span class="c1"># get decimal date</span>
                <span class="p">(</span><span class="n">hr</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">sec</span><span class="p">)</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="n">_decimalDate</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">hr</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">minute</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="p">))</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span>

                <span class="c1"># check if system name is blank</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># check if location is null</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

                <span class="c1"># get type B uncertainty from table</span>
<span class="c1">#                unc = self.cal_unc.getUnc(row[&#39;species&#39;], row[&#39;system&#39;], row[&#39;inst&#39;], date, row[&#39;mixratio&#39;])</span>
                <span class="n">unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_unc</span><span class="o">.</span><span class="n">getUncertainty</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="n">date</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">],</span> <span class="n">inst</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">],</span> <span class="n">system</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">])</span>
<span class="c1">#                print(&quot;unc is&quot;, unc)</span>
                <span class="c1"># getUncertainty() returns -999.99 if no matching rules are found.  Handle this here.</span>
                <span class="k">if</span> <span class="n">unc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">unc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#                row[&#39;unc&#39;] = unc</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;typeB_unc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unc</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># if gas isn&#39;t specified but official is true, then filter out any cals that are not official for each gas</span>
        <span class="c1"># (e.g. LGR2 is official for co but not n2o, but the above query will get n2o LGR2 cals even if official is True)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">official</span><span class="p">:</span>
            <span class="n">mycals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">gaslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_species</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">mygas</span> <span class="ow">in</span> <span class="n">gaslist</span><span class="p">:</span>
                <span class="n">syslist</span> <span class="o">=</span> <span class="n">get_syslist</span><span class="p">(</span><span class="n">mygas</span><span class="p">)</span>

                <span class="c1"># get only the cals for this gas</span>
                <span class="n">cals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">mygas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="n">cals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">syslist</span><span class="p">]</span>

                <span class="n">mycals</span> <span class="o">=</span> <span class="n">mycals</span> <span class="o">+</span> <span class="n">cals</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="o">=</span> <span class="n">mycals</span>
            

        <span class="c1"># get isotope flask data for certain cases</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="o">==</span> <span class="s2">&quot;CO2C13&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="o">==</span> <span class="s2">&quot;CO2O18&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_flasks</span><span class="p">()</span>



    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_get_fill_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tanksn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get filling information for a specific tank serial number &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tanksn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT serial_number,date,code,location,method,type,h2o,notes FROM reftank.fill &quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;WHERE serial_number=&#39;</span><span class="si">%s</span><span class="s2">&#39; ORDER BY date&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tanksn</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c1"># if no results, return empty list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfill</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span>

        <span class="c1"># add a fake row at the end to use as end fill</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;serial_number&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span><span class="n">dt</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span>
            <span class="s1">&#39;location&#39;</span><span class="p">:</span><span class="s1">&#39;BLD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;h2o&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span><span class="s1">&#39;Fake entry&#39;</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfill</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">)</span>


    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.showDbList"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.showDbList">[docs]</a>    <span class="k">def</span> <span class="nf">showDbList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Show serial number of tanks that have been calibrated. &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># output formatted as multi column</span>
        <span class="n">maxl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanks</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;serial_number&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">maxl</span><span class="p">:</span> <span class="n">maxl</span> <span class="o">=</span> <span class="n">l</span>

        <span class="n">colwidth</span> <span class="o">=</span> <span class="n">maxl</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">-</span><span class="si">%d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colwidth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">_getTerminalWidth</span><span class="p">()</span>
    <span class="c1">#       columns -= 10  # leave some space for scrollbar</span>
        <span class="n">ncolumns</span> <span class="o">=</span> <span class="n">columns</span><span class="o">//</span><span class="n">colwidth</span>
        <span class="n">nentries</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tanks</span><span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">nentries</span><span class="o">//</span><span class="n">ncolumns</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">nentries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncolumns</span><span class="p">):</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="p">(</span><span class="n">nrows</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">nentries</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">+=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tanks</span><span class="p">[</span><span class="n">ix</span><span class="p">][</span><span class="s1">&#39;serial_number&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span></div>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.showFillList"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.showFillList">[docs]</a>    <span class="k">def</span> <span class="nf">showFillList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print out list of filling information for a tank &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%11s</span><span class="s2"> </span><span class="si">%12s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%14s</span><span class="s2"> </span><span class="si">%12s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2"> </span><span class="si">%7s</span><span class="s2">   </span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Serial_Number,Fill_Date,Code,Location,Method,Type,H2o,Notes&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Serial Number  Fill Date   Code      Location      Method        Type     H2o    Notes&quot;</span><span class="p">)</span>
                <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--------------------------------------------------------------------------------------&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">format1</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;serial_number&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;h2o&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFillCode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fc</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.showResults"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.showResults">[docs]</a>    <span class="k">def</span> <span class="nf">showResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">showheader</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showflasks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print calibration results, either as table of dates and mole fractions,</span>
<span class="sd">        or as table of calibrations with average and standard deviation for</span>
<span class="sd">        each fill code.</span>

<span class="sd">        Formatting of output depends on the how the &#39;fmt&#39; variable is set.</span>
<span class="sd">        Also co2c13 and co2o18 have different headers and format from other gases.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">text</span>

        <span class="n">gaslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_species</span><span class="p">()</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">gaslist</span> <span class="ow">and</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;serial_number,fillcode,date,time,species,system,instrument,method,pressure,value,std.dev.,flag,scale,uncertainty</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">mygas</span> <span class="ow">in</span> <span class="n">gaslist</span><span class="p">:</span>

            <span class="c1"># get only the cals for this gas</span>
            <span class="n">cals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">mygas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">or</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mygas</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;CO2C13&quot;</span><span class="p">,</span> <span class="s2">&quot;CO2O18&quot;</span><span class="p">)):</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;No </span><span class="si">%s</span><span class="s2"> data for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mygas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">showheader</span> <span class="ow">and</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> CALIBRATION SUMMARY FOR TANK # </span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mygas</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">legacy</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;        Date     Loc     Gas   Inst Press   Value     S.D.     Num    Avg    Sdev</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;---------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;        Date     Loc     Gas   System     Inst Press   Value     S.D.     Num    Avg    Sdev</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;--------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>


            <span class="n">fcodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fill_codes_for_cals</span><span class="p">(</span><span class="n">cals</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fillcode</span> <span class="ow">in</span> <span class="n">fcodes</span><span class="p">:</span>
                <span class="n">fcals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fillcode</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_text</span><span class="p">(</span><span class="n">fcals</span><span class="p">,</span> <span class="n">legacy</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_html</span><span class="p">(</span><span class="n">fcals</span><span class="p">,</span> <span class="n">fillcode</span><span class="p">,</span> <span class="n">mygas</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_csv</span><span class="p">(</span><span class="n">fcals</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_cals</span><span class="p">(</span><span class="n">cals</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">showflasks</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_flasks</span><span class="p">(</span><span class="s2">&quot;CO2C13&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_flasks</span><span class="p">(</span><span class="s2">&quot;CO2O18&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="o">==</span> <span class="s2">&quot;CO2C13&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="o">==</span> <span class="s2">&quot;CO2O18&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">showflasks</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_flasks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span></div>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.showAverages"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.showAverages">[docs]</a>    <span class="k">def</span> <span class="nf">showAverages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print only average values for each fillcode, not individual calibrations &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%3d</span><span class="s2"> </span><span class="si">%9.3f</span><span class="s2"> </span><span class="si">%7.3f</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">gaslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_species</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">gaslist</span> <span class="ow">and</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;fillcode,serial_number,num_cals,average,std.dev.,gas&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mygas</span> <span class="ow">in</span> <span class="n">gaslist</span><span class="p">:</span>

            <span class="c1"># get cals for this gas</span>
            <span class="n">cals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">mygas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

            <span class="n">fcodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fill_codes_for_cals</span><span class="p">(</span><span class="n">cals</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fillcode</span> <span class="ow">in</span> <span class="n">fcodes</span><span class="p">:</span>
                <span class="n">fcals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fillcode</span><span class="p">]</span>

                <span class="c1"># get average values for each fillcode</span>
                <span class="n">avg</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAvgs</span><span class="p">(</span><span class="n">fcals</span><span class="p">)</span>
                <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format1</span> <span class="o">%</span> <span class="p">(</span><span class="n">fillcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">mygas</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.showTankSummary"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.showTankSummary">[docs]</a>    <span class="k">def</span> <span class="nf">showTankSummary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">showheader</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print out summary calibration results &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">text</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">showheader</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Serial_num,Fillcode,Date,Time,Gas,M.R.,S.D.,N,Type,Inst,System,Pressure,Flag,Notes&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Serial_num,Fillcode,Date,Time,Gas,M.R.,S.D.,N,Type,Inst,System,Pressure,Flag&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Serial #  Fillcode       Date       Time        Gas      M.R.      S.D.     N           Type      Sytem    Inst  Pressure Flag  Notes&quot;</span><span class="p">)</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--------------------------------------------------------------------------------------------------------------------------------------&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Serial #  Fillcode       Date       Time        Gas      M.R.      S.D.     N           Type      System   Inst  Pressure Flag&quot;</span><span class="p">)</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-------------------------------------------------------------------------------------------------------------------------------&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span>
                <span class="n">_format</span> <span class="o">+=</span> <span class="s2">&quot;,</span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%-12s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%15s</span><span class="s2"> </span><span class="si">%9s</span><span class="s2"> </span><span class="si">%8s</span><span class="s2"> </span><span class="si">%10.3f</span><span class="s2"> </span><span class="si">%8.3f</span><span class="s2"> </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%18s</span><span class="s2"> </span><span class="si">%8s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%8s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span>
                <span class="n">_format</span> <span class="o">+=</span> <span class="s2">&quot;  # </span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;serial_number&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">],)</span>

            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_format</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.showTable"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.showTable">[docs]</a>    <span class="k">def</span> <span class="nf">showTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print results in a table format.</span>
<span class="sd">        This means print decimal date instead of date string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%12.6f</span><span class="s2"> </span><span class="si">%8.3f</span><span class="s2"> </span><span class="si">%1s</span><span class="s2"> </span><span class="si">%4s</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.6f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="n">gaslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_species</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">gaslist</span> <span class="ow">and</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;fillcode,serial_number,num_cals,average,std.dev.,gas&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mygas</span> <span class="ow">in</span> <span class="n">gaslist</span><span class="p">:</span>

            <span class="c1"># get cals for this gas</span>
            <span class="n">cals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">mygas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span><span class="p">:</span>
                <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format1</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;dd&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>


    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.showCalsByFill"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.showCalsByFill">[docs]</a>    <span class="k">def</span> <span class="nf">showCalsByFill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print cals by fill.  This will print a header for every fillcode,</span>
<span class="sd">        even if there are no cals for that fillcode.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">gaslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_species</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">gaslist</span> <span class="ow">and</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;fillcode,serial_number,num_cals,average,std.dev.,gas&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mygas</span> <span class="ow">in</span> <span class="n">gaslist</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">dct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">:</span>
                <span class="n">fillcode</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fillcode</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="k">continue</span>

                <span class="n">cals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fillcode</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">mygas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

                <span class="k">if</span> <span class="n">fmt</span> <span class="o">!=</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> Calibrations for fill code </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mygas</span><span class="p">,</span> <span class="n">fillcode</span><span class="p">))</span>

                <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%2s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2">  </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%4s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2">  </span><span class="si">%8.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%1s</span><span class="s2">&quot;</span>
                <span class="n">format2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%.3f</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span>
                    <span class="n">format1</span> <span class="o">+=</span> <span class="s2">&quot; # </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="n">format2</span> <span class="o">+=</span> <span class="s2">&quot;,</span><span class="si">%s</span><span class="s2">&quot;</span>

                <span class="n">_format</span> <span class="o">=</span> <span class="n">format1</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="n">_format</span> <span class="o">=</span> <span class="n">format2</span>

                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">],</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">],</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">],</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">],</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">],</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">],)</span>

                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_format</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>


    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_print_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cals</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print results in text format .</span>
<span class="sd">        cals is list of calibration results for a single gas.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2">  </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%7s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2"> </span><span class="si">%6s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2">  </span><span class="si">%8.3f</span><span class="s2"> </span><span class="si">%7.3f</span><span class="s2"> </span><span class="si">%1s</span><span class="s2">&quot;</span>
        <span class="n">_format2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%75d%9.3f</span><span class="s2"> </span><span class="si">%7.3f</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">legacy</span><span class="p">:</span>
            <span class="n">_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2">  </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%7s</span><span class="s2"> </span><span class="si">%6s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2">  </span><span class="si">%8.3f</span><span class="s2"> </span><span class="si">%7.3f</span><span class="s2"> </span><span class="si">%1s</span><span class="s2">&quot;</span>
            <span class="n">_format2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%65d%9.3f</span><span class="s2"> </span><span class="si">%7.3f</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span> <span class="n">_format</span> <span class="o">+=</span> <span class="s2">&quot; # </span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span><span class="p">:</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pressure</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">legacy</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">],</span>
                    <span class="n">pressure</span><span class="p">,</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">],</span>
                    <span class="n">pressure</span><span class="p">,</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">],</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">],)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_format</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>


        <span class="n">avg</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAvgs</span><span class="p">(</span><span class="n">cals</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_format2</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">stdv</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_print_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cals</span><span class="p">,</span> <span class="n">fcode</span><span class="p">,</span> <span class="n">gas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print results in format for a web page.</span>
<span class="sd">        Since these results go to the public, for co2c13 and co2o18 results,</span>
<span class="sd">        show only one significant digit and don&#39;t calculate and show the</span>
<span class="sd">        average for them.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scales</span><span class="p">[</span><span class="n">gas</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">gas</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;co2c13&#39;</span> <span class="ow">or</span> <span class="n">gas</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;co2o18&#39;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> INFORMATION FOR TANK # </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gas</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&lt;pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; Fill   Date     Loc     Gas  Inst Press   Value </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;-------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;Filling Code &lt;span class=&#39;fillcode bold blue&#39;&gt;</span><span class="si">%s</span><span class="s2">.&lt;/span&gt;&amp;nbsp;&amp;nbsp; Scale </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fcode</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&lt;pre&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;        Date     Loc  Inst Pressure   Value    S.D.   Unc*      Num    Avg    Sdev</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span><span class="p">:</span>
            <span class="n">fillcode</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span>
            <span class="n">caldate</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">mr</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">]</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">]</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">]</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>
            <span class="n">unc</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;typeB_unc&#39;</span><span class="p">]</span>

            <span class="c1"># text += result of this cal</span>
            <span class="k">if</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pressure</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;co2c13&quot;</span><span class="p">,</span> <span class="s2">&quot;co2o18&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">mr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%4s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2">  </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%7s</span><span class="s2"> </span><span class="si">%4s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2">    -999.9</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fillcode</span><span class="p">,</span> <span class="n">caldate</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">pressure</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%4s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2">  </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%7s</span><span class="s2"> </span><span class="si">%4s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2">  </span><span class="si">%8.1f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fillcode</span><span class="p">,</span> <span class="n">caldate</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">mr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%4s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2">  </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2"> </span><span class="si">%8s</span><span class="s2"> </span><span class="si">%8.2f</span><span class="s2"> </span><span class="si">%6.2f</span><span class="s2"> </span><span class="si">%6.2f</span><span class="s2"> </span><span class="si">%1s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">caldate</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">cals</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gas</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;co2c13&quot;</span> <span class="ow">and</span> <span class="n">gas</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;co2o18&quot;</span><span class="p">):</span>
            <span class="n">avg</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAvgs</span><span class="p">(</span><span class="n">cals</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%66d%9.2f</span><span class="s2"> </span><span class="si">%7.2f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">stdv</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/pre&gt;&lt;br&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">text</span>

    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_print_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print calibration information in json format. &quot;&quot;&quot;</span>

        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span><span class="p">:</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pressure</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scales</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]]</span>

            <span class="n">a</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;fill_code&quot;</span>       <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">],</span>
                <span class="s2">&quot;serial_number&quot;</span>   <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;serial_number&#39;</span><span class="p">],</span>
                <span class="s2">&quot;date&quot;</span>            <span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]),</span>
                <span class="s2">&quot;time&quot;</span>            <span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                <span class="s2">&quot;parameter&quot;</span>       <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span>
                <span class="s2">&quot;value&quot;</span>           <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">]),</span>
                <span class="s2">&quot;std._dev.&quot;</span>       <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">]),</span>
                <span class="s2">&quot;num_samples&quot;</span>     <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">],</span>
                <span class="s2">&quot;type&quot;</span>            <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">],</span>
                <span class="s2">&quot;system&quot;</span>          <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span>
                <span class="s2">&quot;instrument_code&quot;</span> <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">],</span>
                <span class="s2">&quot;tank_pressure&quot;</span>   <span class="p">:</span> <span class="n">pressure</span><span class="p">,</span>
                <span class="s2">&quot;flag&quot;</span>            <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span>
                <span class="s2">&quot;scale&quot;</span>           <span class="p">:</span> <span class="n">scale</span><span class="p">,</span>
                <span class="s2">&quot;uncertainty&quot;</span>     <span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;typeB_unc&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span>
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>


    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_print_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Print calibration information in csv format. &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span><span class="p">:</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pressure</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scales</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]]</span>

            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;serial_number&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">],</span>
                <span class="n">pressure</span><span class="p">,</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">],</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span>
                <span class="n">scale</span><span class="p">,</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;typeB_unc&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_notes</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">],)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>

            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>


    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_get_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the scale that is being used for the species &quot;&quot;&quot;</span>

        <span class="c1"># scale name is that for the current=1 scale in scales table</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select name from reftank.scales where species=&#39;</span><span class="si">%s</span><span class="s2">&#39; and current=1&quot;</span> <span class="o">%</span> <span class="n">species</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="c1">#        print(result)</span>

        <span class="c1"># except for co2, which has archived data in different scale in separate database</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">!=</span> <span class="s2">&quot;reftank&quot;</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;co2&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;CO2_X2007&quot;</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="s2">&quot;None&quot;</span>

    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_get_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a list of species analyzed from the calibrations &quot;&quot;&quot;</span>

        <span class="n">gaslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="p">:</span>
                <span class="n">gas</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">gas</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gaslist</span><span class="p">:</span>
                    <span class="n">gaslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gaslist</span><span class="p">)</span>

    <span class="c1">#------------------------------------------------------------------------</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_fill_codes_for_cals</span><span class="p">(</span><span class="n">cals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; take a list of cal results and extract a list of unique fill codes &quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span><span class="p">:</span>
            <span class="n">fcode</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fcode</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">a</span>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.getFillCode"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.getFillCode">[docs]</a>    <span class="k">def</span> <span class="nf">getFillCode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find the correct fill code for a given date. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">adate</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adate</span> <span class="o">=</span> <span class="n">date</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">filldate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">fillcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
            <span class="n">nextfilldate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">filldate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nextfilldate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
<span class="c1">#            if date &gt;= filldate and date &lt; nextfilldate:</span>
            <span class="k">if</span> <span class="n">filldate</span> <span class="o">&lt;=</span> <span class="n">adate</span> <span class="o">&lt;</span> <span class="n">nextfilldate</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fillcode</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.getFillDate"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.getFillDate">[docs]</a>    <span class="k">def</span> <span class="nf">getFillDate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find the fill date for a given calendar date. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">adate</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adate</span> <span class="o">=</span> <span class="n">date</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">filldate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">nextfilldate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">filldate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nextfilldate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">filldate</span> <span class="o">&lt;=</span> <span class="n">adate</span> <span class="o">&lt;</span> <span class="n">nextfilldate</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">filldate</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.getFlag"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.getFlag">[docs]</a>    <span class="k">def</span> <span class="nf">getFlag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the flag for a calibration on given date &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="p">:</span>
            <span class="n">caldate</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">caldate</span> <span class="o">==</span> <span class="n">date</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="s1">&#39;.&#39;</span></div>

    <span class="c1">#------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.getAvgs"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.getAvgs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getAvgs</span><span class="p">(</span><span class="n">cals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the average, stddev, and n for given calibrations.</span>
<span class="sd">        The cals are for a single fillcode.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get unflagged values</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">]</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">stdv</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stdv</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.99</span>
            <span class="n">stdv</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.99</span>

        <span class="k">return</span> <span class="n">avg</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">num</span></div>


    <span class="c1">#----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.getAverage"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.getAverage">[docs]</a>    <span class="k">def</span> <span class="nf">getAverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="n">mygas</span><span class="p">,</span> <span class="n">fillcode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the average value for the given tank serial number and fill code &quot;&quot;&quot;</span>

        <span class="n">cals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">mygas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="n">fcals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fillcode</span><span class="p">]</span>
        <span class="n">avg</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAvgs</span><span class="p">(</span><span class="n">fcals</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">avg</span></div>

    <span class="c1">#----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.getValue"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mygas</span><span class="p">,</span> <span class="n">fillcode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the value for the given tank and fill code that can be used</span>
<span class="sd">        to put an entry into the scale_assignments table.</span>

<span class="sd">        Returns:</span>
<span class="sd">            result : namedtuple with (tzero, coef0, unc0, coef1, unc1, coef2, unc2)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">instruments</span> <span class="o">=</span> <span class="n">INST_CODES</span><span class="p">[</span><span class="n">mygas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="n">cals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">mygas</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>  <span class="c1"># get cals for this gas</span>
        <span class="n">fcals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fillcode</span><span class="p">]</span>   <span class="c1"># get cals for fillcode</span>
        <span class="n">fcals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fcals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">]</span>  <span class="c1"># get unflagged cals</span>
        <span class="n">ocals</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fcals</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">]</span>   <span class="c1"># get official cals only</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">ccg_calfit</span><span class="o">.</span><span class="n">fitCalibrations</span><span class="p">(</span><span class="n">ocals</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

    <span class="c1">#----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_check_cals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check for problems in database, such as cal before first fill,</span>
<span class="sd">        fills after last cal, no fillings for a tank.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">text</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;Warning: No filling information found.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">firstfilldate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">firstcaldate</span> <span class="o">=</span> <span class="n">cals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">firstcaldate</span> <span class="o">&lt;</span> <span class="n">firstfilldate</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;===&gt; WARNING: There are calibrations before the first filling date. &lt;===</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">lastcaldate</span> <span class="o">=</span> <span class="n">cals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">lastfilldate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nfill</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lastfilldate</span> <span class="o">&gt;</span> <span class="n">lastcaldate</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;===&gt; WARNING: There are fillings after last calibration. &lt;===</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">text</span>

    <span class="c1">#----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_get_flasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get any flasks that have been filled from a tank and</span>
<span class="sd">        analyzed for isotopes c13 and o18.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT num from ccgg.flask_event where comment like &#39;%&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span> <span class="o">+</span> <span class="s2">&quot;%&#39;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">elist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">elist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">]))</span>

            <span class="n">events</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elist</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>

                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select value, unc, flag, inst, system, date, parameter_num &quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;from ccgg.flask_data &quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;where event_num in (</span><span class="si">%s</span><span class="s2">) and parameter_num=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                <span class="n">result2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result2</span><span class="p">:</span>
                        <span class="n">date</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFillCode</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillingcode</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillingcode</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">flasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1">#----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_print_flasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gas</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; print out information for flasks filled from tank and analyzed for isotopes. &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">text</span>

        <span class="k">if</span> <span class="n">gas</span> <span class="o">==</span> <span class="s2">&quot;CO2C13&quot;</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="n">flsks</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flasks</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;parameter_num&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">param</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flsks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">text</span>

        <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2">  </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%7s</span><span class="s2"> </span><span class="si">%10s</span><span class="s2"> </span><span class="si">%4s</span><span class="s2"> </span><span class="si">%5s</span><span class="s2">  </span><span class="si">%8.1f</span><span class="s2"> </span><span class="si">%6.1f</span><span class="s2"> </span><span class="si">%1s</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">format1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%.1f</span><span class="s2">,</span><span class="si">%.1f</span><span class="s2">,</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">!=</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2"> FLASK SAMPLES FOR TANK # </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&lt;pre&gt;&quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; Fill   Date     Loc     Gas   System   Inst Press   Value    S.D.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;----------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">flsks</span><span class="p">:</span>
            <span class="n">fillcode</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;fillcode&#39;</span><span class="p">]</span>
            <span class="n">caldate</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">system</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;unc&#39;</span><span class="p">]</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">format1</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span> <span class="n">fillcode</span><span class="p">,</span> <span class="n">caldate</span><span class="p">,</span> <span class="s2">&quot;BLD&quot;</span><span class="p">,</span> <span class="n">gas</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="s2">&quot;----&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">format1</span> <span class="o">%</span> <span class="p">(</span><span class="n">fillcode</span><span class="p">,</span> <span class="n">caldate</span><span class="p">,</span> <span class="s2">&quot;BLD&quot;</span><span class="p">,</span> <span class="n">gas</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="s2">&quot;----&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/pre&gt;&lt;br&gt;&quot;</span>

        <span class="k">return</span> <span class="n">text</span>

    <span class="c1">#----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.checkDb"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.checkDb">[docs]</a>    <span class="k">def</span> <span class="nf">checkDb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cal_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check results with data in database</span>

<span class="sd">        Args:</span>
<span class="sd">            cal_data : namedtuple containing</span>
<span class="sd">                (adate, mf, sd, ncycles, method, pressure, site, regulator, inst, system, flag)</span>
<span class="sd">            verbose : boolean.  If true print out extra messages while updating.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this shouldn&#39;t ever happen but check anyway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Gas species must be specified for checks.&quot;</span><span class="p">)</span>

        <span class="n">date</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:00&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;calibrations&quot;</span>

        <span class="c1"># info line for messages</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%12s</span><span class="s2"> </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%02d</span><span class="s2"> </span><span class="si">%02d</span><span class="s2"> </span><span class="si">%02d</span><span class="s2"> </span><span class="si">%9.3f</span><span class="s2"> </span><span class="si">%7.3f</span><span class="s2"> </span><span class="si">%3d</span><span class="s2"> </span><span class="si">%4s</span><span class="s2"> </span><span class="si">%3s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">frmt</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">mf</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">sd</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">ncycles</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">inst</span><span class="p">,</span>
            <span class="n">cal_data</span><span class="o">.</span><span class="n">regulator</span>
        <span class="p">)</span>

<span class="c1">#        print(cal_data)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_record</span><span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">inst</span><span class="p">)</span>
<span class="c1">#        print(&quot;record is&quot;, record)</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># If nothing found, check if it&#39;s a serial number mismatch</span>

            <span class="c1"># First by checking if the date, time and mole fraction agree</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT serial_number FROM </span><span class="si">%s</span><span class="s2"> WHERE &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;date=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="n">date</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND time=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="n">time</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND mixratio=</span><span class="si">%f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">mf</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND species=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND inst=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">inst</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">dbsn</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;serial_number&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Serial number mismatch (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">dbsn</span><span class="p">))</span>

            <span class="c1"># check if serial numbers are similar</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT serial_number FROM </span><span class="si">%s</span><span class="s2"> WHERE &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;date=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="n">date</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND time=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="n">time</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND species=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND serial_number like &#39;</span><span class="si">%%%s%%</span><span class="s2">&#39; &quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">tank</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND inst=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">inst</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">dbsn</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;serial_number&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Possible serial number mismatch (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">dbsn</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># check if date, location, instrument match but not time</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT time FROM </span><span class="si">%s</span><span class="s2"> WHERE &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;date=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="n">date</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND serial_number=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND species=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND inst=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">inst</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND location=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">site</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">dbsn</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Time mismatch (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">dbsn</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">  not found.&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if mole fraction agree.</span>
            <span class="n">mr2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;mixratio&#39;</span><span class="p">])</span>
            <span class="n">stdv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;stddev&#39;</span><span class="p">])</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">mf</span> <span class="o">-</span> <span class="n">mr2</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> mole fraction mismatch (</span><span class="si">%8.3f</span><span class="s2">, </span><span class="si">%6.3f</span><span class="s2">, diff = </span><span class="si">%6.3f</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">mr2</span><span class="p">,</span> <span class="n">stdv</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tank </span><span class="si">%10s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> OK&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span></div>


    <span class="c1">#----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.updateDb"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.updateDb">[docs]</a>    <span class="k">def</span> <span class="nf">updateDb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cal_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the database with results of calibration.</span>

<span class="sd">        Args:</span>
<span class="sd">            cal_data : namedtuple containing</span>
<span class="sd">                (adate, mf, sd, ncycles, method, pressure, site, regulator, inst, system, flag)</span>
<span class="sd">            verbose : boolean.  If true print out extra messages while updating.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Class must be initialized with ``readonly=False`` argument for updates</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this shouldn&#39;t ever happen but check anyway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Gas species must be specified for updates.&quot;</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;calibrations&quot;</span>


        <span class="n">date</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:00&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>

        <span class="c1"># Find the record.</span>
        <span class="c1"># If no record, insert new one, else update existing data</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_record</span><span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO </span><span class="si">%s</span><span class="s2"> SET &quot;</span> <span class="o">%</span> <span class="n">table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;UPDATE </span><span class="si">%s</span><span class="s2"> SET &quot;</span> <span class="o">%</span> <span class="n">table</span>

        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;mixratio=</span><span class="si">%.4f</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">mf</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;stddev=</span><span class="si">%.3f</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">sd</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;num=</span><span class="si">%d</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">ncycles</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;method=&#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">method</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;system=&#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">system</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;pressure=</span><span class="si">%s</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">pressure</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;location=&#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">site</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;regulator=&#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">regulator</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;meas_unc=</span><span class="si">%.3f</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">meas_unc</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;mod_date=now() &quot;</span>

        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;, date=&#39;</span><span class="si">%s</span><span class="s2">&#39;, time=&#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;serial_number=&#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;inst=&#39;</span><span class="si">%s</span><span class="s2">&#39;, &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">inst</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;species=&#39;</span><span class="si">%s</span><span class="s2">&#39;, flag=&#39;.&#39;, &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;parameter_num=</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">paramnum</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;WHERE idx=</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#        self.db.commit()</span>

        <span class="c1"># update our results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_results</span><span class="p">()</span></div>

    <span class="c1">#----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Calibrations.deleteDb"><a class="viewcode-back" href="../tankcals/caldb.html#ccg_cal_db.Calibrations.deleteDb">[docs]</a>    <span class="k">def</span> <span class="nf">deleteDb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cal_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Delete a record from the database</span>

<span class="sd">        Args:</span>
<span class="sd">            cal_data : tuple containing</span>
<span class="sd">                (adate, co2, sd, ncycles, method, pressure, sitecode, regulator, inst, flag)</span>
<span class="sd">            verbose : boolean.  If true print out extra messages while updating.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Class must be initialized with ``readonly=False`` argument for deletes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;calibrations&quot;</span>

        <span class="n">date</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%4d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:00&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">adate</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>

        <span class="c1"># Delete the record.</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM </span><span class="si">%s</span><span class="s2"> WHERE &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;serial_number=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tank</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND date=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="n">date</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND time=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="n">time</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND species=&#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;AND inst=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">cal_data</span><span class="o">.</span><span class="n">inst</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">doquery</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<span class="c1">#        self.db.commit()</span>

<span class="c1"># OR</span>

<span class="c1">#        record = self._find_record(cal_data.adate, cal_data.inst)</span>
<span class="c1">#        if record is not None:</span>
<span class="c1">#            query = &quot;DELETE FROM %s WHERE idx=%d&quot; % (table, record[&#39;idx&#39;])</span>
<span class="c1">#            if verbose:</span>
<span class="c1">#                print(sql)</span>
<span class="c1">#            self.db.doquery(sql, commit=True)</span>
    

    <span class="c1">#----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_find_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find if this calibration record is already in the database.</span>
<span class="sd">        The Calibrations class MUST have been created with the species and tank serial number</span>
<span class="sd">        given as arguments.</span>
<span class="sd">        Loop through the cals and see if any match.</span>

<span class="sd">        Input:</span>
<span class="sd">            date - datetime object of analysis date</span>

<span class="sd">        Return the self.cals dict entry if a match is found, otherwise return None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># self.cals is already filtered by tank serial number and gas on creation</span>
<span class="c1">#        print(&quot;search for &quot;, date)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cals</span><span class="p">:</span>
<span class="c1">#            print(d)</span>
            <span class="n">caldate</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>

<span class="c1">#            print(d)</span>
            <span class="n">adate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">caldate</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">caldate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">caldate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="n">time</span>
<span class="c1">#            print(caldate, time, adate, date)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">adate</span> <span class="o">==</span> <span class="n">date</span> 
                <span class="ow">and</span> <span class="n">inst</span> <span class="o">==</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;inst&#39;</span><span class="p">]):</span>
<span class="c1">#                and paramnum == d[&#39;parameter_num&#39;]):</span>
                <span class="k">return</span> <span class="n">d</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">dbc</span> <span class="o">=</span> <span class="n">ccg_db_conn</span><span class="o">.</span><span class="n">RO</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="s1">&#39;reftank&#39;</span><span class="p">)</span>

    <span class="n">sn</span> <span class="o">=</span> <span class="s2">&quot;CC71623&quot;</span>
    <span class="n">gas</span> <span class="o">=</span> <span class="s2">&quot;co2&quot;</span>
    <span class="n">cals</span> <span class="o">=</span> <span class="n">Calibrations</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">gas</span><span class="p">,</span> <span class="n">dbconn</span><span class="o">=</span><span class="n">dbc</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">cals</span><span class="o">.</span><span class="n">showResults</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
<span class="c1">#    json = cals.showResults(fmt=&#39;json&#39;)</span>
<span class="c1">#    print(json)</span>
<span class="c1">#    html = cals.showResults(fmt=&#39;html&#39;)</span>
<span class="c1">#    print(html)</span>
    <span class="n">fillcode</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">cals</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s2">&quot;co2&quot;</span><span class="p">,</span> <span class="n">fillcode</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>